{"ast":null,"code":"import _createForOfIteratorHelper from\"/Users/yamazakikouji/Desktop/ec-app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper\";import _regeneratorRuntime from\"/Users/yamazakikouji/Desktop/ec-app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/yamazakikouji/Desktop/ec-app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import{db,FirebaseTimestamp}from\"../../firebase\";import{push}from\"connected-react-router\";import{deleteProductAction,fetchProductsAction,fetchKeywordAction,fetchSearchProductsAction}from'./actions';var productsRef=db.collection('products');export var deleteProduct=function deleteProduct(id){return/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(dispatch,getState){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:productsRef.doc(id).delete().then(function(){var prevProducts=getState().products.list;var nextProducts=prevProducts.filter(function(product){return product.id!==id;});dispatch(deleteProductAction(nextProducts));});case 1:case\"end\":return _context.stop();}}},_callee);}));return function(_x,_x2){return _ref.apply(this,arguments);};}();};export var fetchKeyword=function fetchKeyword(keyword){return/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(dispatch){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:dispatch(fetchKeywordAction(keyword));case 1:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x3){return _ref2.apply(this,arguments);};}();};export var fetchProducts=function fetchProducts(gender,category){return/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(dispatch){var query;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:query=productsRef.orderBy('updated_at','desc');query=gender!==\"\"?query.where('gender','==',gender):query;query=category!==\"\"?query.where('category','==',category):query;query.get().then(function(snapshots){var productList=[];snapshots.forEach(function(snapshot){var product=snapshot.data();productList.push(product);});dispatch(fetchProductsAction(productList));});case 4:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x4){return _ref3.apply(this,arguments);};}();};// export const fetchSearchProducts = () => {\n//     return async(dispatch) => {\n//         let query = productsRef.orderBy('updated_at','desc');\n//         query.get()\n//             .then(snapshots => {\n//                 const productList = []\n//                 snapshots.forEach(snapshot => {\n//                     const product = snapshot.data();\n//                     productList.push(product)\n//                 })\n//                 dispatch(fetchSearchProductsAction(productList))\n//             })\n//     }\n// }\nexport var orderProduct=function orderProduct(productInCart,amount){return/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(dispatch,getState){var uid,userRef,timestamp,products,soldOutProducts,batch,_iterator,_step,_loop,errorMessage;return _regeneratorRuntime.wrap(function _callee4$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:uid=getState().users.uid;userRef=db.collection('users').doc(uid);timestamp=FirebaseTimestamp.now();products=[],soldOutProducts=[];batch=db.batch();_iterator=_createForOfIteratorHelper(productInCart);_context5.prev=6;_loop=/*#__PURE__*/_regeneratorRuntime.mark(function _loop(){var product,snapshot,sizes,updatedSizes;return _regeneratorRuntime.wrap(function _loop$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:product=_step.value;_context4.next=3;return productsRef.doc(product.productId).get();case 3:snapshot=_context4.sent;sizes=snapshot.data().sizes;updatedSizes=sizes.map(function(size){if(size.size===product.size){if(size.quantity===0){soldOutProducts.push(product.name);return size;}return{size:size.size,quantity:size.quantity-1};}else{return size;}});products.push({id:product.productId,images:product.images,name:product.name,price:product.price,size:product.size});batch.update(productsRef.doc(product.productId),{sizes:updatedSizes});batch.delete(userRef.collection('cart').doc(product.cartId));case 9:case\"end\":return _context4.stop();}}},_loop);});_iterator.s();case 9:if((_step=_iterator.n()).done){_context5.next=13;break;}return _context5.delegateYield(_loop(),\"t0\",11);case 11:_context5.next=9;break;case 13:_context5.next=18;break;case 15:_context5.prev=15;_context5.t1=_context5[\"catch\"](6);_iterator.e(_context5.t1);case 18:_context5.prev=18;_iterator.f();return _context5.finish(18);case 21:if(!(soldOutProducts.length>0)){_context5.next=27;break;}errorMessage=soldOutProducts.length>1?soldOutProducts.join('と'):soldOutProducts[0];alert('大変申し訳ありません。'+errorMessage+'が在庫切れとなったため、注文処理を中断しました。');return _context5.abrupt(\"return\",false);case 27:batch.commit().then(function(){var orderRef=userRef.collection('orders').doc();var date=timestamp.toDate();var shippingDate=FirebaseTimestamp.fromDate(new Date(date.setDate(date.getDate()+3)));var history={amount:amount,created_at:timestamp,id:orderRef.id,products:products,shipping_date:shippingDate,updated_at:timestamp};orderRef.set(history);dispatch(push('/order/complete'));}).catch(function(){alert('注文処理に失敗しました。通信環境をご確認のうえ、もう一度お試しください。');return false;});case 28:case\"end\":return _context5.stop();}}},_callee4,null,[[6,15,18,21]]);}));return function(_x5,_x6){return _ref4.apply(this,arguments);};}();};export var saveProduct=function saveProduct(id,name,discription,category,gender,price,images,sizes){return/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(dispatch){var timestamp,data,ref;return _regeneratorRuntime.wrap(function _callee5$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:timestamp=FirebaseTimestamp.now();data={category:category,discription:discription,gender:gender,images:images,name:name,price:parseInt(price,10),sizes:sizes,updated_at:timestamp};if(id===\"\"){ref=productsRef.doc();id=ref.id;data.id=id;data.created_at=timestamp;}return _context6.abrupt(\"return\",productsRef.doc(id).set(data,{merge:true}).then(function(){dispatch(push('/'));}).catch(function(error){throw new Error(error);}));case 4:case\"end\":return _context6.stop();}}},_callee5);}));return function(_x7){return _ref5.apply(this,arguments);};}();};","map":{"version":3,"sources":["/Users/yamazakikouji/Desktop/ec-app/src/redux/products/operations.js"],"names":["db","FirebaseTimestamp","push","deleteProductAction","fetchProductsAction","fetchKeywordAction","fetchSearchProductsAction","productsRef","collection","deleteProduct","id","dispatch","getState","doc","delete","then","prevProducts","products","list","nextProducts","filter","product","fetchKeyword","keyword","fetchProducts","gender","category","query","orderBy","where","get","snapshots","productList","forEach","snapshot","data","orderProduct","productInCart","amount","uid","users","userRef","timestamp","now","soldOutProducts","batch","productId","sizes","updatedSizes","map","size","quantity","name","images","price","update","cartId","length","errorMessage","join","alert","commit","orderRef","date","toDate","shippingDate","fromDate","Date","setDate","getDate","history","created_at","shipping_date","updated_at","set","catch","saveProduct","discription","parseInt","ref","merge","error","Error"],"mappings":"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","sourcesContent":["import { db, FirebaseTimestamp } from \"../../firebase\";\nimport { push } from \"connected-react-router\";\nimport { deleteProductAction, fetchProductsAction, fetchKeywordAction, fetchSearchProductsAction } from './actions';\n\nconst productsRef = db.collection('products');\n\nexport const deleteProduct = (id) => {\n    return async(dispatch, getState) => {\n        productsRef.doc(id).delete()\n            .then(() => {\n                const prevProducts = getState().products.list;\n                const nextProducts = prevProducts.filter(product => product.id !== id)\n                dispatch(deleteProductAction(nextProducts))\n            })\n    }\n}\n\nexport const fetchKeyword = (keyword) => {\n    return async(dispatch) => {\n        dispatch(fetchKeywordAction(keyword))\n    }\n}\n\nexport const fetchProducts = (gender, category) => {\n    return async(dispatch) => {\n        let query = productsRef.orderBy('updated_at','desc');\n        query = (gender !== \"\") ? query.where('gender', '==', gender) : query;\n        query = (category !== \"\") ? query.where('category', '==', category) : query;\n\n        query.get()\n            .then(snapshots => {\n                const productList = []\n                snapshots.forEach(snapshot => {\n                    const product = snapshot.data();\n                    productList.push(product)\n                })\n                dispatch(fetchProductsAction(productList))\n            })\n    }\n}\n\n// export const fetchSearchProducts = () => {\n//     return async(dispatch) => {\n//         let query = productsRef.orderBy('updated_at','desc');\n\n//         query.get()\n//             .then(snapshots => {\n//                 const productList = []\n//                 snapshots.forEach(snapshot => {\n//                     const product = snapshot.data();\n//                     productList.push(product)\n//                 })\n//                 dispatch(fetchSearchProductsAction(productList))\n//             })\n//     }\n// }\n\nexport const orderProduct = (productInCart, amount) => {\n    return async(dispatch, getState) => {\n        const uid = getState().users.uid;\n        const userRef = db.collection('users').doc(uid);\n        const timestamp = FirebaseTimestamp.now();\n\n        let products = [],\n            soldOutProducts = [];\n\n        const batch = db.batch()\n\n        for(const product of productInCart){\n            const snapshot = await productsRef.doc(product.productId).get()\n            const sizes = snapshot.data().sizes\n\n            const updatedSizes = sizes.map(size => {\n                if(size.size === product.size){\n                    if(size.quantity === 0){\n                        soldOutProducts.push(product.name)\n                        return size\n                    }\n                    return{\n                        size: size.size,\n                        quantity: size.quantity - 1\n                    }\n                } else{\n                    return size\n                }\n            })\n\n            products.push({\n                id: product.productId,\n                images: product.images,\n                name: product.name,\n                price: product.price,\n                size: product.size\n            })\n\n            batch.update(\n                productsRef.doc(product.productId),\n                {sizes: updatedSizes}\n            )\n\n            batch.delete(\n                userRef.collection('cart').doc(product.cartId)\n            )\n        }\n\n        if(soldOutProducts.length > 0){\n            const errorMessage = (soldOutProducts.length > 1) ? soldOutProducts.join('と') : soldOutProducts[0]\n            alert('大変申し訳ありません。'　+ errorMessage + 'が在庫切れとなったため、注文処理を中断しました。')\n            return false\n        }else{\n            batch.commit().then(() => {\n                const orderRef = userRef.collection('orders').doc();\n                const date = timestamp.toDate();\n                const shippingDate = FirebaseTimestamp.fromDate(new Date(date.setDate(date.getDate() + 3)));\n\n                const history = {\n                    amount: amount,\n                    created_at: timestamp,\n                    id: orderRef.id,\n                    products: products,\n                    shipping_date: shippingDate,\n                    updated_at: timestamp\n                }\n                orderRef.set(history)\n                dispatch(push('/order/complete'))\n\n            }).catch(() => {\n                alert('注文処理に失敗しました。通信環境をご確認のうえ、もう一度お試しください。')\n                return false\n            })\n        }\n    }\n}\n\nexport const saveProduct = (id, name, discription, category, gender, price, images, sizes) => {\n    return async(dispatch) => {\n        const timestamp = FirebaseTimestamp.now()\n\n        const data = {\n            category: category,\n            discription: discription,\n            gender: gender,\n            images: images,\n            name: name,\n            price: parseInt(price, 10),\n            sizes: sizes,\n            updated_at: timestamp\n        }\n\n        if(id === \"\"){\n            const ref = productsRef.doc()\n            id = ref.id\n            data.id = id\n            data.created_at = timestamp\n        }\n\n        return productsRef.doc(id).set(data, {merge: true})\n            .then(() => {\n                dispatch(push('/'))\n            }).catch((error) => {\n                throw new Error(error)\n            })\n    }\n}"]},"metadata":{},"sourceType":"module"}